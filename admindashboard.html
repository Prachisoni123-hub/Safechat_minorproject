<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeChat Admin Dashboard</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6fb;
  }

  .navbar {
    background: #1a237e; /* LNCT Blue */
    color: white;
    padding: 15px;
    font-size: 22px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logout-btn {
    background: #ff6f00; /* LNCT Orange */
    border: none;
    padding: 10px 15px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 5px;
  }

  .container {
    width: 95%;
    margin: 30px auto;
  }

  h2 {
    text-align: center;
    color: #1a237e;
  }

  .filters {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  select, input[type="text"] {
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
  }

  th {
    background: #1a237e;
    color: white;
    padding: 12px;
    font-size: 16px;
  }

  td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
  }

  tr:hover {
    background: #e8eaf6;
  }

  .btn-status, .btn-delete {
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    margin-right: 5px;
    font-size: 12px;
  }

  .pending { background: #f44336; }   /* Red */
  .working { background: #ff9800; }   /* Orange */
  .resolved { background: #4caf50; }  /* Green */
  .delete { background: #9c27b0; }    /* Purple */
</style>
</head>
<body>

<div class="navbar">
  SafeChat Admin Dashboard
  <button class="logout-btn" onclick="window.location.href='admin.html'">Logout</button>
</div>

<div class="container">
  <h2>All Anonymous Complaints</h2>

  <div class="filters">
    <div>
      Filter by Status: 
      <select id="statusFilter">
        <option value="">All</option>
        <option value="Pending">Pending</option>
        <option value="Working">Working</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>
    <div>
      Filter by Category: 
      <select id="categoryFilter">
        <option value="">All</option>
        <option>Faculty</option>
        <option>Hostel</option>
        <option>Mess</option>
        <option>Campus Facilities</option>
        <option>Other</option>
      </select>
    </div>
    <div>
      Search: <input type="text" id="searchInput" placeholder="Search complaints">
    </div>
  </div>

  <table id="complaintTable">
    <tr>
      <th>Complaint</th>
      <th>Category</th>
      <th>Status</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  </table>
</div>

<script type="module">
import { db, ref, onValue, update, push } from "./firebase-config.js";

const table = document.getElementById("complaintTable");
const statusFilter = document.getElementById("statusFilter");
const categoryFilter = document.getElementById("categoryFilter");
const searchInput = document.getElementById("searchInput");

let complaints = {}; // store all complaints locally

const complaintRef = ref(db, "complaints/");

// Load all complaints live
onValue(complaintRef, (snapshot) => {
  complaints = snapshot.exists() ? snapshot.val() : {};
  renderTable();
});

// Render table with filters & search
function renderTable() {
  table.innerHTML = `
    <tr>
      <th>Complaint</th>
      <th>Category</th>
      <th>Status</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  `;

  const statusVal = statusFilter.value;
  const categoryVal = categoryFilter.value;
  const searchVal = searchInput.value.toLowerCase();

  if (!complaints || Object.keys(complaints).length === 0) {
    table.innerHTML += `
      <tr>
        <td colspan="5" style="text-align:center;">No complaints yet</td>
      </tr>
    `;
    return;
  }

  Object.keys(complaints).forEach(id => {
    const data = complaints[id];

    if ((statusVal && data.status !== statusVal) ||
        (categoryVal && data.category !== categoryVal) ||
        (searchVal && !data.text.toLowerCase().includes(searchVal))) return;

    let row = document.createElement('tr');

    // Color row based on status
    let bgColor = '';
    if (data.status === 'Pending') bgColor = '#ffebee';
    else if (data.status === 'Working') bgColor = '#fff3e0';
    else if (data.status === 'Resolved') bgColor = '#e8f5e9';
    row.style.backgroundColor = bgColor;

    row.innerHTML = `
      <td>${data.text}</td>
      <td>${data.category}</td>
      <td>${data.status}</td>
      <td>${data.timestamp}</td>
      <td>
        <button class="btn-status pending" onclick="updateStatus('${id}','Pending')">Pending</button>
        <button class="btn-status working" onclick="updateStatus('${id}','Working')">Working</button>
        <button class="btn-status resolved" onclick="updateStatus('${id}','Resolved')">Resolved</button>
        <button class="btn-delete delete" onclick="deleteComplaint('${id}')">Delete</button>
      </td>
    `;
    table.appendChild(row);
  });
}

// Update complaint status
window.updateStatus = (id, newStatus) => {
  update(ref(db, "complaints/" + id), { status: newStatus });
};

// Delete complaint
window.deleteComplaint = (id) => {
  if (confirm("Are you sure you want to delete this complaint?")) {
    update(ref(db, "complaints/" + id), { deleted: true });
  }
};

// Filter and search events
statusFilter.addEventListener('change', renderTable);
categoryFilter.addEventListener('change', renderTable);
searchInput.addEventListener('input', renderTable);
</script>

</body>
</html>
